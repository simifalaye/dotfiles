#!/bin/bash
#
# Installs core dependencies needed to deploy dotfiles

# Usage: has <cmd-1> <cmd-2> ... <cmd-n>
function has {
  for cmd in "$@"; do
    command -v "$cmd" >/dev/null || return 1
  done
}

# - Installs core dependencies:
#   - python3
#   - python3-pip
#   - curl
#   - gnu-stow
#   - pipx (for installing ansible)
#   - ansible
function install_deps {
  echo "### Installing dependencies"
  # Exit if anything fails within the function
  set -e

  # Install required apps
  os="$(uname)"
  case $os in
    'Darwin')
      echo "### Detected macOS"
      brew update
      brew install python curl stow pipx
      pipx ensurepath
      ;;
    'Linux')
      echo "### Detected Linux"
      if [ -f /etc/os-release ]; then
        # Install core dependencies
        if grep -q -E '(debian|ubuntu|linuxmint)' /etc/os-release; then
          echo "Detected Debian/Ubuntu/Linux Mint"
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip curl stow
        elif grep -q -E '(centos|rhel|fedora)' /etc/os-release; then
          echo "Detected CentOS/RHEL/Fedora"
          if [ -f /etc/centos-release ]; then
            sudo yum update
            sudo yum install -y epel-release
          fi
          sudo yum install -y python3 python3-pip curl stow
        elif grep -q -E '(arch)' /etc/os-release; then
          echo "Detected Arch"
          sudo pacman -Syyu --noconfirm python python-pip curl stow
        elif grep -q -E '(opensuse)' /etc/os-release; then
          echo "Detected openSUSE"
          sudo zypper update
          sudo zypper install -y python3 python3-pip curl stow
        else
          echo "Unsupported Linux distribution"
          exit 1
        fi
        # Install pipx
        python3 -m pip install --user pipx
        python3 -m pipx ensurepath
      else
        echo "Unsupported Linux distribution"
        exit 1
      fi
      ;;
    *)
      echo "Unsupported OS"
      exit 1
      ;;
  esac

  # Install ansible and community modules
  pip install ansible requests
  pipx install --include-deps ansible
  ansible-galaxy collection install community.general
}

#-
#  Main
#-

# Install deps if not installed
if ! has curl ansible stow; then
  if ! install_deps; then
    echo "### Failed to install dependencies"
    exit 0
  fi
fi

# Run Ansible
ansible-playbook -i ./hosts ./playbook.yml --ask-become-pass
